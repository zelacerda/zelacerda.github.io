<!doctype html>
<html>
    <head>
        <title>Space Rescue</title>
        <meta charset="utf-8">
        <script type="text/javascript" src="../brython.js"></script>
        <script type="text/javascript" src="../brython_stdlib.js"></script>
        <link rel="stylesheet" type="text/css" href="space.css">
    </head>
    <body onload="brython()">
        <script type="text/python">

from math import radians, sin, cos

from browser import document as doc
from browser.html import SVG, DIV, P, AUDIO
from browser import svg, bind, timer

KEYRIGHT = 39
KEYLEFT = 37
KEYUP = 38

def to_vector(angle):
    rad = radians(angle)
    xcomp = cos(rad)
    ycomp = sin(rad)
    return xcomp, ycomp


class Ship:
    def __init__(self):
        self.x = 400
        self.y = 300
        self.image = svg.image(href='ship0.png',
                                     x=self.x,
                                     y=self.y)
        self.xvel = 0
        self.yvel = 0
        self.acc = 0
        self.angle = 0
        self.key_right = False
        self.key_left = False
        self.key_up = False

    def update_angle(self):
        if self.key_right is True:
            self.angle += 3
        if self.key_left is True:
            self.angle -= 3
        self.image.attrs['transform'] = f'rotate({self.angle}, {self.x}, {self.y})'

    def update_vel(self):
        if self.key_up is True:
            self.acc = 0.2
            self.image.attrs['href'] = 'assets/ship1.png'
            doc['thrust'].play()
        else:
            self.acc = 0.0
            self.image.attrs['href'] = 'assets/ship0.png'
            doc['thrust'].load()
            doc['thrust'].pause()
        self.xvel += self.acc * to_vector(self.angle)[0]
        self.yvel += self.acc * to_vector(self.angle)[1]
        self.xvel *= 0.99
        self.yvel *= 0.99

    def update_pos(self):
        self.x += self.xvel
        self.y += self.yvel
        self.x %= 800
        self.y %= 600
        self.image.attrs['x'] = self.x - 45
        self.image.attrs['y'] = self.y - 45

    def update(self):
        self.update_angle()
        self.update_vel()
        self.update_pos()


@bind(doc, 'keydown')
def keydown(evt):
    key = evt.keyCode
    if key == KEYRIGHT:
        ship.key_right = True
    elif key == KEYLEFT:
        ship.key_left = True
    elif key == KEYUP:
        ship.key_up = True

@bind(doc, 'keyup')
def keyup(evt):
    key = evt.keyCode
    if key == KEYRIGHT:
        ship.key_right = False
    elif key == KEYLEFT:
        ship.key_left = False
    elif key == KEYUP:
        ship.key_up = False

def update():
    ship.update()

def main():
    global ship
    ship = Ship()
    doc <= DIV('SPACE RESCUE', id='title')
    doc <= DIV(id='frame')
    doc['frame'] <= SVG(id='area')
    doc <= AUDIO(id='thrust', src='assets/thrust.wav')
    doc['area'] <= ship.image
    timer.set_interval(update, 20)

main()
        </script>
    </body>
</html>
