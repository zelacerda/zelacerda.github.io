<html><head><title>tort.ooo</title><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=0, viewport-fit=cover">
<script type="text/javascript" src="brython.js"></script>
<script type="text/javascript" src="brython_stdlib.js"></script>
<link rel="stylesheet" type="text/css" href="parole.css"></head>
<body onload="brython()"></body>
<script type="text/javascript">
js = {share: function(str){return alert(str)}}</script>
</html>


<script type="text/python">

import time
import json
from random import seed

from browser import document as doc
from browser import window, bind, timer, ajax
from browser.html import TABLE, TR, TD, DIV, SPAN, HR, BUTTON

from utils import get_letters, count2sec


def get_day_game():
    init_time = 1644116400 # 2022-02-06 00:00
    now = int(time.time())
    day_game = int((now - init_time) / 86400) + 1
    return day_game

def roll_dices(game):
    seed(game)
    letters = [get_letters(4) for _ in range(4)]
    return letters

def create_grid(letters):
    grid = TABLE()
    for row in range(4):
        grid <= TR(TD(DIV(
	    letters[row][col],
	    id=f"dice-{row}-{col}",
	    Class="inactive")) for col in range(4))
    return grid


def read(req):
    response = json.loads(req.responseText)
    word = response['result']
    print(word)


def checa(req):
    global pontos
    response = json.loads(req.responseText)
    word = response['result']
    print(response)
    print(f"Recebi a palavra {word}")

    if word:
        l = len(word)
        if l < 5:
            p = 1
        elif l == 5:
            p = 2
        elif l == 6:
            p = 3
        elif l == 7:
            p = 5
        else:
            p = 8
        doc["area"].textContent += f"{word}-{p} "
        pontos += p
        doc["pontos"].textContent = f"PONTOS: {pontos}"


def envia(word):
    global guesses
    l = len(word)
    if l > 2 and word not in guesses:
        guesses.append(word)
        ajax.get(f"https://app-pkmnt5mjza-rj.a.run.app/{word.lower()}", oncomplete=checa)
    cancela()


def cancela():
    global pos_x, pos_y
    doc["word"].textContent = ""
    for row in range(4):
        for col in range(4):
            doc[f"dice-{row}-{col}"].class_name = "inactive"
    pos_x, pos_y = None, None


@bind("body", "click")
def click(event):
    """
    Handler para eventos de clique.
    """
    element = event.target

    if element.id == "envia":
        envia(doc["word"].textContent)
    elif element.id == "cancela":
        cancela()
    elif element.id[:4] == "dice":
        check_letter(element)


def adjacent(x1, y1, x2, y2):
    dist = max(abs(x2-x1), abs(y2-y1))
    return dist == 1


def check_letter(element):
    global pos_x, pos_y
    _, row, col = element.id.split("-")
    if pos_x is not None:
        adj = adjacent(pos_x, pos_y, int(col), int(row))
    else:
        adj = False
    content = element.textContent
    if (content != "" and adj and element.class_name == "inactive") or (pos_x is None):
        doc["word"].textContent += element.textContent
        element.class_name = "active"
        pos_x, pos_y = int(col), int(row)


def update_timer():
    global count
    count -= 1
    if count > 0:
        doc["timer"].textContent = count2sec(count)
    else:
        doc["timer"].textContent = "Acabou!"
        reset()


def reset():
    global pos_x, pos_y
    pos_x, pos_y = 0, 0
    for row in range(4):
        for col in range(4):
            doc[f"dice-{row}-{col}"].class_name = "active"


def main():
    game = get_day_game()
    letters = roll_dices(game)
    grid = create_grid(letters)
    doc <= SPAN("tort.ooo", id="title", Class="title")
    doc <= HR()
    doc <= DIV(f"PONTOS: {pontos}", id="pontos", Class="pontos")
    doc <= DIV("3:00", id="timer", Class="timer")
    doc <= grid
    cont1 = DIV(Class="container")
    cont1 <= DIV("", id="word", Class="word")
    cont1 <= DIV("✘", id="cancela", Class="cancela")
    cont1 <= DIV("✔", id="envia", Class="envia")
    doc <= cont1
    doc <= DIV("", id="area", Class="area")

count = 180
pontos = 0
pos_x, pos_y = None, None
guesses = []

main()

timer.set_interval(update_timer, 1000)

</script>
