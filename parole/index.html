<html><head><title>Paro.le</title><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=0, viewport-fit=cover">
<script type="text/javascript" src="../brython.js"></script>
<script type="text/javascript" src="../brython_stdlib.js"></script>
<link rel="stylesheet" type="text/css" href="parole.css"></head>
<body onload="brython()"></body></html>
<script type="text/python">

import time
import json
from random import seed

from browser import document as doc
from browser import window, bind, timer, ajax
from browser.html import TABLE, TR, TD, DIV, SPAN, HR, BUTTON

from utils import get_letters, count2sec


def get_day_game():
    init_time = 1644116400 # 2022-02-06 00:00
    now = int(time.time())
    day_game = int((now - init_time) / 86400) + 1
    return day_game

def roll_dices(game):
    seed(game)
    letters = [get_letters(4) for _ in range(4)]
    return letters

def create_grid(letters):
    grid = TABLE()
    for row in range(4):
        grid <= TR(TD(DIV(
	    letters[row][col],
	    id=f"dice-{row}-{col}",
	    Class="inactive")) for col in range(4))
    return grid


def read(req):
    response = json.loads(req.responseText)
    word = response['result']
    print(word)


def envia(word):
    global pontos
    print(f"Vou enviar a palavra {word}")
    l = len(word)
    if l < 5:
        p = 1
    elif l == 5:
        p = 2
    elif l == 6:
        p = 3
    elif l == 7:
        p = 5
    else:
        p = 8
    doc["area"].textContent += f"{word}-{p} "
    pontos += p
    doc["pontos"].textContent = str(pontos)
    cancela()
    # ajax.get(f"https://app-pkmnt5mjza-rj.a.run.app/{word}", oncomplete=read)


def cancela():
    doc["word"].textContent = ""
    for row in range(4):
        for col in range(4):
            doc[f"dice-{row}-{col}"].class_name = "inactive"


@bind("body", "click")
def click(event):
    """
    Handler para eventos de clique.
    """
    element = event.target

    if element.id == "envia":
        envia(doc["word"].textContent)
    elif element.id == "cancela":
        cancela()
    elif element.id[:4] == "dice":
        _, row, col = element.id.split("-")
        print(f"Clicou na linha {row} e coluna {col}")
        check_letter(element)


def check_letter(element):
    content = element.textContent
    if content != "" and element.class_name == "inactive":
        doc["word"].textContent += element.textContent
        element.class_name = "active"


def update_timer():
    global count
    count -= 1
    if count > 0:
        doc["timer"].textContent = count2sec(count)
    else:
        doc["timer"].textContent = "Fim de jogo!"
        reset()


def reset():
    for row in range(4):
        for col in range(4):
            doc[f"dice-{row}-{col}"].textContent = ""
            doc[f"dice-{row}-{col}"].class_name = "inactive"


def main():
    game = get_day_game()
    letters = roll_dices(game)
    grid = create_grid(letters)
    doc <= SPAN("paro.le", id="title", Class="title")
    doc <= HR()
    doc <= DIV("3:00", id="timer", Class="timer")
    doc <= DIV(str(pontos), id="pontos", Class="pontos")
    doc <= grid
    doc <= DIV("", id="area", Class="area")
    doc <= DIV("", id="cancela", Class="cancela")
    doc <= DIV("", id="word", Class="word")
    doc <= DIV("", id="envia", Class="envia")


count = 180
pontos = 0

main()

timer.set_interval(update_timer, 1000)

</script>
